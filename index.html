<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportSphere - Social Sports Platform</title>

    <!-- PWA: Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA: Theme Color for browser UI -->
    <meta name="theme-color" content="#06B6D4">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- React and Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #111827; font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .custom-scrollbar-nav::-webkit-scrollbar { display: none; }
        .custom-scrollbar-nav { -ms-overflow-style: none; scrollbar-width: none; }
        .toggle { -webkit-appearance: none; -moz-appearance: none; appearance: none; height: 1.5rem; width: 2.75rem; border-radius: 9999px; background-color: #4b5563; position: relative; cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .toggle:checked { background-color: #06B6D4; }
        .toggle::before { content: ""; position: absolute; top: 0.25rem; left: 0.25rem; height: 1rem; width: 1rem; border-radius: 9999px; background-color: white; transition: transform 0.2s ease-in-out; }
        .toggle:checked::before { transform: translateX(1.25rem); }
        .moment-video-embed iframe { width: 100%; height: 100%; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCT9bFZUkQ25JUNhW00XnvUWMa1kO9fI0o",
            authDomain: "sportysphere-pwa.firebaseapp.com",
            projectId: "sportysphere-pwa",
            storageBucket: "sportysphere-pwa.appspot.com",
            messagingSenderId: "850598542865",
            appId: "1:850598542865:web:d482a25411733391157bb0",
            measurementId: "G-Q474YZP0BM"
        };

        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- React Hooks ---
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // --- Data & Configuration ---
        const navigationItems = [
          { id: 'home', label: 'Home', icon: '🏠' }, { id: 'live', label: 'Live Games', icon: '📊' },
          { id: 'moments', label: 'Moments', icon: '🎥' }, { id: 'betting', label: 'Betting', icon: '💰' },
          { id: 'news', label: 'News', icon: '📰' }, { id: 'shop', label: 'Shop', icon: '🛒' },
          { id: 'profile', label: 'Profile', icon: '👤' },
        ];
        const roleIcons = { Fan: '👑', Player: '👕', Reporter: '📝', Analyst: '📈', Team: '🏟️', Sponsor: '💲', Advertiser: '🏷️', Referee: '📣', NewsChannel: '📺', Admin: '🔑', AIAdmin: '🤖' };
        const userSelectableRoles = [
            { id: 'Fan', desc: 'Follow teams, players, and share your passion for sports.' },
            { id: 'Player', desc: 'Showcase your skills, stats, and connect with fans.' },
            { id: 'Reporter', desc: 'Share news, interviews, and insights about the sports world.' },
            { id: 'Analyst', desc: 'Provide data-driven insights and predictions.' },
        ];

        // --- Helper Hooks & Functions ---
        function useScrollDirection() {
          const [scrollDirection, setScrollDirection] = useState(null);
          const lastScrollY = useRef(0);

          useEffect(() => {
            const updateScrollDirection = () => {
              const scrollY = window.scrollY;
              const direction = scrollY > lastScrollY.current ? "down" : "up";
              if (direction !== scrollDirection && (Math.abs(scrollY - lastScrollY.current) > 10)) {
                setScrollDirection(scrollY < 50 ? "up" : direction);
              }
              lastScrollY.current = scrollY > 0 ? scrollY : 0;
            };
            window.addEventListener("scroll", updateScrollDirection, { passive: true });
            return () => window.removeEventListener("scroll", updateScrollDirection);
          }, [scrollDirection]);
          return scrollDirection;
        }

        // --- General UI Components ---
        const LoadingSpinner = ({ text = "Loading..." }) => <div className="flex flex-col items-center justify-center h-full p-8 text-white"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500 mb-4"></div><p>{text}</p></div>;
        const ErrorMessage = ({ message }) => <div className="p-4 md:p-8 text-center text-red-400"><p>Error: {message}</p></div>;
        const SectionHeader = ({ title }) => <h3 className="text-2xl font-bold text-white mb-6">{title}</h3>;
        const InfoCard = ({ title, children }) => (<div className="mb-8"><h4 className="text-xl font-semibold text-white mb-4 border-b-2 border-gray-700 pb-2">{title}</h4><div className="bg-gray-800/50 p-4 rounded-lg space-y-3">{children}</div></div>);
        const TrophyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M11 2a1 1 0 10-2 0v1a1 1 0 102 0V2z" /><path fillRule="evenodd" d="M10 4a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 4zM6 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" /><path fillRule="evenodd" d="M3.5 8a.5.5 0 01.5-.5h12a.5.5 0 010 1H4a.5.5 0 01-.5-.5zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /><path d="M8.25 15.25a.75.75 0 01.75-.75h2a.75.75 0 010 1.5h-2a.75.75 0 01-.75-.75zM7 17a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" /></svg>;

        // --- Profile Components ---
        const ProfileHeader = ({ user, profileData }) => (
            <div className="flex flex-col sm:flex-row justify-between items-center mb-6">
                <div className="flex items-center space-x-6">
                    <img src={profileData.photo || user.photoURL || `https://placehold.co/200x200/1f2937/4b5563?text=${user.displayName?.charAt(0) || 'U'}`} alt={`${user.displayName} profile`} className="w-24 h-24 sm:w-32 sm:h-32 rounded-full border-4 border-cyan-500 object-cover" />
                    <div>
                        <h1 className="text-3xl sm:text-4xl font-bold text-white">{profileData.name || user.displayName}</h1>
                        <p className="text-lg text-cyan-400">{profileData.role}</p>
                        {profileData.affiliation && <p className="text-md text-gray-300">{profileData.affiliation}</p>}
                    </div>
                </div>
            </div>
        );

        const RoleSelection = ({ user, onRoleSelected }) => {
            const [isSavingRole, setIsSavingRole] = useState(false);
            const handleRoleSelect = async (newRole) => {
                if (!user || !user.uid) return;
                setIsSavingRole(true);
                try {
                    await db.collection('users').doc(user.uid).update({ role: newRole, roleSelected: true });
                    onRoleSelected(newRole);
                } catch (error) { console.error("Error updating user role:", error); } 
                finally { setIsSavingRole(false); }
            };

            return (
                <div className="text-center py-10">
                    <h2 className="text-2xl font-bold text-white mb-6">Select Your Role</h2>
                    <p className="text-gray-300 mb-8">Choose how you want to participate in SportSphere</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                        {userSelectableRoles.map(r => (
                            <button key={r.id} onClick={() => handleRoleSelect(r.id)} disabled={isSavingRole} className="p-6 bg-gray-700 rounded-xl hover:bg-gray-600 transition-colors duration-200 text-left disabled:opacity-50 disabled:cursor-not-allowed">
                                <div className="flex items-center space-x-3 mb-2"><span className="text-2xl">{roleIcons[r.id]}</span><h3 className="text-xl font-bold">{r.id}</h3></div>
                                <p className="text-gray-300 text-sm">{r.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };
        
        const PlayerProfile = ({ user, profileData }) => {
            const [playerStats, setPlayerStats] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const fetchPlayerStats = async (playerName) => {
                    const apiKey = '2'; // Free test key from TheSportsDB
                    const url = `https://www.thesportsdb.com/api/v1/json/${apiKey}/searchplayers.php?p=${encodeURIComponent(playerName)}`;
                    try {
                        const response = await fetch(url);
                        const data = await response.json();
                        if (data.player && data.player.length > 0) {
                            setPlayerStats(data.player[0]);
                        }
                    } catch (error) {
                        console.error('Failed to fetch player stats:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchPlayerStats(profileData.name || user.displayName);
            }, [profileData.name, user.displayName]);

            return (
                <>
                    <ProfileHeader user={user} profileData={profileData} />
                    {isLoading ? <LoadingSpinner text="Fetching Player Stats..." /> : 
                        playerStats ? (
                            <>
                                <p className="text-gray-300 mb-6">{playerStats.strDescriptionEN || profileData.bio}</p>
                                <InfoCard title="Player Details">
                                    <p><strong>Team:</strong> {playerStats.strTeam}</p>
                                    <p><strong>Nationality:</strong> {playerStats.strNationality}</p>
                                    <p><strong>Position:</strong> {playerStats.strPosition}</p>
                                </InfoCard>
                            </>
                        ) : <p className="text-gray-400 mb-6">No detailed stats available.</p>
                    }
                </>
            );
        };

        const UserProfile = ({ user, onRoleChange }) => {
            const [profileData, setProfileData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                const unsubscribe = db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        setProfileData(doc.data());
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const handleRoleSelected = (newRole) => {
                setProfileData(prev => ({ ...prev, role: newRole }));
                onRoleChange(newRole);
            };

            if (isLoading) return <div className="p-8 text-center"><LoadingSpinner /></div>;
            if (!profileData) return <ErrorMessage message="Could not load user profile." />;

            const renderProfileContent = () => {
                if (!profileData.role) return <RoleSelection user={user} onRoleSelected={handleRoleSelected} />;
                switch (profileData.role) {
                    case 'Player': return <PlayerProfile user={user} profileData={profileData} />;
                    default: return <ProfileHeader user={user} profileData={profileData} />;
                }
            };

            return (<div className="p-4 md:p-8"><div className="max-w-6xl mx-auto"><main className="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8">{renderProfileContent()}</main></div></div>);
        };

        // --- Navigation and Main Content Components ---
        const LandingPage = () => {
            const [showLoginOptions, setShowLoginOptions] = useState(false);
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const handleGoogleLogin = async () => { setIsLoggingIn(true); try { const provider = new firebase.auth.GoogleAuthProvider(); await firebase.auth().signInWithPopup(provider); } catch (error) { console.error("Google Sign-In Error:", error); } finally { setIsLoggingIn(false); } };
            const handleAdminLogin = async () => { setIsLoggingIn(true); try { await firebase.auth().signInWithEmailAndPassword('davidmbazza@gmail.com', 'TEST123'); } catch (error) { alert("Admin login failed. Please check credentials."); } finally { setIsLoggingIn(false); } };
            
            return (
                <div className="relative w-full min-h-screen flex flex-col justify-center items-center text-center p-4 overflow-hidden" style={{ backgroundImage: 'url(https://images.unsplash.com/photo-1579952363873-27f3bade9f55?q=80&w=2970&auto=format&fit=crop)', backgroundSize: 'cover', backgroundPosition: 'center' }}>
                    <div className="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"></div>
                    <div className="relative z-10 text-white max-w-2xl mx-auto flex flex-col items-center">
                        <h1 className="text-4xl md:text-6xl font-extrabold mb-4">Welcome to <br /><span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-orange-500">SportSphere</span></h1>
                        <p className="text-lg md:text-xl mb-8 leading-relaxed">The ultimate social platform for sports fans, players, and experts. Connect, share, and experience sports like never before.</p>
                        {!showLoginOptions ? (<button onClick={() => setShowLoginOptions(true)} className="flex items-center justify-center px-8 py-3 bg-cyan-500 rounded-full font-semibold text-lg shadow-lg hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105">Join Community</button>) : (<div className="bg-gray-800/80 rounded-xl p-8 backdrop-blur-sm w-full max-w-sm"><h2 className="text-2xl font-bold mb-6">Sign In</h2><div className="space-y-4"><button onClick={handleGoogleLogin} disabled={isLoggingIn} className="w-full flex items-center justify-center space-x-2 px-6 py-3 bg-white text-gray-800 rounded-full font-semibold hover:bg-gray-200 transition-colors duration-200 disabled:opacity-50"><svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg><span>Continue with Google</span></button></div></div>)}
                    </div>
                    <div className="absolute bottom-4 left-4 z-10"><button onClick={handleAdminLogin} disabled={isLoggingIn} className="h-12 w-12 flex items-center justify-center bg-gray-800/80 text-gray-400 rounded-full font-semibold hover:bg-gray-700 hover:text-white transition-colors duration-200 disabled:opacity-50" title="Admin Login"><svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L4.257 19.743A1 1 0 012.843 18.33l6.002-6.001A6.002 6.002 0 0118 8zm-6 3a4 4 0 100-8 4 4 0 000 8z" clipRule="evenodd"></path></svg></button></div>
                </div>
            );
        };
        
        const TopNavigationBar = ({ scrollDirection, onSettingsClick, user }) => (
          <header className={`fixed top-0 left-0 right-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm z-40 p-4 flex justify-between items-center border-b border-gray-700 md:pl-20 transition-transform duration-300 ${scrollDirection === 'down' ? '-translate-y-full' : 'translate-y-0'}`}>
            <div className="flex items-center space-x-2 md:hidden"><svg className="w-8 h-8 text-cyan-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg><span className="text-2xl font-extrabold text-cyan-500">SportSphere</span></div>
            <div className="hidden md:flex items-center space-x-4"><input type="text" placeholder="Search SportSphere..." className="bg-gray-800 border border-gray-700 rounded-full px-4 py-1.5 text-sm w-72 focus:outline-none focus:ring-2 focus:ring-cyan-500" /></div>
            <div className="flex items-center space-x-2 sm:space-x-4">
              <button className="text-gray-400 hover:text-white p-2 rounded-full"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg></button>
              <button onClick={onSettingsClick} className="text-gray-400 hover:text-white p-2 rounded-full"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
              {user && <img src={user.photoURL || `https://placehold.co/40x40/1f2937/4b5563?text=${user.displayName?.charAt(0) || 'U'}`} className="w-8 h-8 rounded-full" alt="User avatar" />}
            </div>
          </header>
        );

        const DesktopSidebar = ({ activeTab, setActiveTab }) => (
            <aside className="hidden md:flex fixed top-0 left-0 h-full w-20 bg-gray-900 border-r border-gray-800 flex-col items-center py-6 space-y-4 z-50">
                <div className="text-3xl font-bold text-cyan-500">S</div>
                <nav className="flex flex-col items-center space-y-2 mt-8">
                    {navigationItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`p-3 rounded-lg transition-colors duration-200 ${activeTab === item.id ? 'bg-cyan-500 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-white'}`} title={item.label}><span className="text-2xl">{item.icon}</span></button>))}
                </nav>
            </aside>
        );

        const BottomTabNavigation = ({ activeTab, setActiveTab, scrollDirection }) => (
            <nav className={`md:hidden fixed bottom-0 left-0 right-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm border-t border-gray-700 flex justify-around p-2 z-40 transition-transform duration-300 ${scrollDirection === 'down' ? 'translate-y-full' : 'translate-y-0'}`}>
                {navigationItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors duration-200 ${activeTab === item.id ? 'text-cyan-400' : 'text-gray-400 hover:text-white'}`} title={item.label}><span className="text-2xl">{item.icon}</span><span className="text-xs">{item.label}</span></button>))}
            </nav>
        );
        
        const SettingsModal = ({ isOpen, onClose, onSignOut }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white">Settings</h2><button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button></div>
                        <div className="space-y-4"><div className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg"><label htmlFor="dark-mode" className="text-gray-200">Dark Mode</label><input type="checkbox" id="dark-mode" className="toggle" defaultChecked /></div><div className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg"><label htmlFor="notifications" className="text-gray-200">Push Notifications</label><input type="checkbox" id="notifications" className="toggle" /></div><button onClick={onSignOut} className="w-full mt-4 px-4 py-2 bg-red-600 rounded-lg text-white hover:bg-red-700 transition-colors duration-200">Sign Out</button></div>
                    </div>
                </div>
            );
        };
        
        const HomeSection = ({ role }) => (<div className="p-4 md:p-8 text-white"><SectionHeader title="Home" /><div className="bg-gray-800 rounded-lg p-6 mb-6"><h2 className="text-xl font-bold mb-2">Welcome back!</h2><p className="text-gray-300">Your current role is: <span className="font-bold text-cyan-400">{role || 'Fan'}</span></p></div></div>);
        
        const LiveGames = () => {
            const [games, setGames] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchGames = async () => {
                    const apiKey = '110a8672debad7a839756e771715dc7d';
                    const url = 'https://v3.football.api-sports.io/fixtures?live=all';
                    
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' }
                        });
                        if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                        const data = await response.json();
                        if (data.response && data.response.length > 0) {
                            setGames(data.response);
                        } else {
                            setError("No live games currently. Check back later!");
                        }
                    } catch (e) {
                        setError(e.message);
                        console.error("Failed to fetch live games:", e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchGames();
            }, []);

            if (isLoading) return <div className="p-8"><LoadingSpinner text="Fetching Live Games..." /></div>;
            if (error) return <ErrorMessage message={error} />;

            return (
                <div className="p-4 md:p-8 text-white">
                    <SectionHeader title="Live Football Matches" />
                    <div className="space-y-4">
                        {games.map(({ fixture, league, teams, goals }) => (
                            <div key={fixture.id} className="bg-gray-800 rounded-xl p-4">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-sm font-semibold text-gray-300">{league.name}</span>
                                    <span className="px-2 py-1 text-white text-xs font-bold rounded-md bg-red-600">{fixture.status?.short}</span>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center"><div className="flex items-center space-x-3"><img src={teams.home?.logo} className="w-8 h-8 object-contain" /><span className="font-semibold text-white text-lg">{teams.home?.name}</span></div><span className="font-bold text-2xl text-white">{goals.home}</span></div>
                                    <div className="flex justify-between items-center"><div className="flex items-center space-x-3"><img src={teams.away?.logo} className="w-8 h-8 object-contain" /><span className="font-semibold text-white text-lg">{teams.away?.name}</span></div><span className="font-bold text-2xl text-white">{goals.away}</span></div>
                                </div>
                                <div className="text-center text-sm text-gray-400 mt-3">{fixture.status?.elapsed}'</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MomentsSection = () => {
            const [moments, setMoments] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchVideoMoments = async () => {
                    const url = 'https://www.scorebat.com/video-api/v3/';
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                        const data = await response.json();
                        if (data.response && data.response.length > 0) {
                            const formattedMoments = data.response.slice(0, 10).map(moment => ({
                                id: moment.title,
                                mediaEmbed: moment.videos[0].embed,
                                caption: moment.title,
                                user: moment.competition.name,
                            }));
                            setMoments(formattedMoments);
                        } else {
                            setError("No recent highlights found.");
                        }
                    } catch (e) {
                        setError(e.message);
                        console.error('Failed to fetch video moments:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchVideoMoments();
            }, []);

            if (isLoading) return <div className="p-8"><LoadingSpinner text="Fetching Latest Highlights..." /></div>;
            if (error) return <ErrorMessage message={error} />;
            
            return (
                <div className="h-screen w-full overflow-y-scroll snap-y snap-mandatory">
                    {moments.map(moment => (
                        <div key={moment.id} className="h-full w-full snap-start relative flex items-center justify-center bg-black">
                            <div className="absolute inset-0 moment-video-embed" dangerouslySetInnerHTML={{ __html: moment.mediaEmbed }} />
                            <div className="absolute bottom-20 left-0 right-0 p-4 bg-gradient-to-t from-black/70 to-transparent">
                                <p className="font-bold text-white">{moment.user}</p>
                                <p className="text-sm text-white">{moment.caption}</p>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const NewsSection = () => {
            const [articles, setArticles] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchNews = async () => {
                    const apiKey = 'c3740fda057d4a7da72346609fa07758';
                    const url = `https://newsapi.org/v2/top-headlines?country=us&category=sports&apiKey=${apiKey}`;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                        const data = await response.json();
                        setArticles(data.articles || []);
                    } catch (e) {
                        setError(e.message);
                        console.error("Failed to fetch news:", e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchNews();
            }, []);

            if (isLoading) return <div className="p-8"><LoadingSpinner text="Fetching News..." /></div>;
            if (error) return <ErrorMessage message={error} />;

            return (
                <div className="p-4 md:p-8 text-white">
                    <SectionHeader title="Latest Sports News" />
                    <div className="space-y-4">
                        {articles.map((article, index) => (
                            <a href={article.url} target="_blank" rel="noopener noreferrer" key={index} className="block bg-gray-800 rounded-xl p-4 hover:bg-gray-700 transition-colors">
                                {article.urlToImage && <img src={article.urlToImage} className="w-full h-48 object-cover rounded-lg mb-4" />}
                                <h3 className="text-lg font-bold mb-1 text-white">{article.title}</h3>
                                <p className="text-sm text-gray-400">{article.source.name} · {new Date(article.publishedAt).toLocaleDateString()}</p>
                                <p className="text-sm text-gray-300 mt-2">{article.description}</p>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        const ShopSection = () => {
            const [products, setProducts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchProducts = async () => {
                    try {
                        const response = await fetch('https://fakestoreapi.com/products');
                        if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                        const data = await response.json();
                        const formattedProducts = data.map(p => ({ id: p.id, name: p.title, price: p.price, imageUrl: p.image }));
                        setProducts(formattedProducts);
                    } catch (e) {
                        setError(e.message);
                        console.error("Failed to fetch products:", e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchProducts();
            }, []);

            if (isLoading) return <div className="p-8"><LoadingSpinner text="Loading Products..." /></div>;
            if (error) return <ErrorMessage message={error} />;

            return (
                <div className="p-4 md:p-8 text-white">
                    <SectionHeader title="SportSphere Shop" />
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {products.map(product => (
                            <div key={product.id} className="bg-gray-800 rounded-xl overflow-hidden flex flex-col">
                                <div className="relative w-full h-56 bg-white p-4"><img src={product.imageUrl} alt={product.name} className="max-h-full max-w-full object-contain mx-auto" /></div>
                                <div className="p-4 flex flex-col flex-grow"><h3 className="text-lg font-bold text-white mb-2 flex-grow">{product.name}</h3><div className="flex items-baseline justify-between"><span className="text-2xl font-bold text-cyan-500">${product.price.toFixed(2)}</span><button className="px-4 py-2 bg-cyan-500 rounded-lg font-semibold text-white hover:bg-cyan-600">Add to Cart</button></div></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const BettingSection = () => (<div className="p-4 md:p-8 text-white"><SectionHeader title="Betting" /><p className="text-gray-400">Betting features are under construction.</p></div>);

        // --- Main App Component ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [showSettings, setShowSettings] = useState(false);
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [isLoadingUser, setIsLoadingUser] = useState(true);
            const scrollDirection = useScrollDirection();

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = db.collection('users').doc(firebaseUser.uid);
                        const userDoc = await userDocRef.get();
                        if (userDoc.exists) {
                            setUserRole(userDoc.data().role || null);
                        } else {
                             const isInitialAdmin = firebaseUser.email === 'davidmbazza@gmail.com';
                             const newUser = { uid: firebaseUser.uid, displayName: firebaseUser.displayName || 'New User', email: firebaseUser.email, photoURL: firebaseUser.photoURL, role: isInitialAdmin ? 'Admin' : null, roleSelected: isInitialAdmin, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                            await userDocRef.set(newUser, { merge: true });
                            setUserRole(newUser.role);
                        }
                        setUser(firebaseUser);
                    } else {
                        setUser(null);
                        setUserRole(null);
                    }
                    setIsLoadingUser(false);
                });
                return () => unsubscribe();
            }, []);

            const handleSignOut = async () => { try { await auth.signOut(); setShowSettings(false); } catch (error) { console.error("Error signing out:", error); } };

            if (isLoadingUser) return <LoadingSpinner />;
            if (!user) return <LandingPage />;

            return (
                <div className="min-h-screen bg-gray-900 text-white pb-20 md:pb-0 md:pl-20">
                    <TopNavigationBar scrollDirection={scrollDirection} onSettingsClick={() => setShowSettings(true)} user={user} />
                    <DesktopSidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <BottomTabNavigation activeTab={activeTab} setActiveTab={setActiveTab} scrollDirection={scrollDirection} />
                    <main className="pt-20">
                        {activeTab === 'home' && <HomeSection role={userRole} />}
                        {activeTab === 'live' && <LiveGames />}
                        {activeTab === 'moments' && <MomentsSection />}
                        {activeTab === 'betting' && <BettingSection />}
                        {activeTab === 'news' && <NewsSection />}
                        {activeTab === 'shop' && <ShopSection />}
                        {activeTab === 'profile' && <UserProfile user={user} onRoleChange={setUserRole} />}
                    </main>
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} onSignOut={handleSignOut} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
